#!/bin/bash

if [[ -e .env ]]; then
  source .env
fi

DEFAULT_LISTEN_PORT=51820

shopt -s nullglob

get_value() {
  local config="$1"
  shift

  if [[ ! -e "$config" ]]; then
    return
  fi

  (
    source "$config"

    for i; do
      if declare -p "$i" &>/dev/null; then
        echo "${!i}"
        return
      fi
    done
  )
}

require_value() {
  local config="$1"
  shift

  if [[ ! -e "$config" ]]; then
    stderr "$config is missing"
    return 1
  fi

  (
    source "$config"

    for i; do
      if declare -p "$i" &>/dev/null; then
        echo "${!i}"
        return
      fi
    done

    stderr "$config the $i is missing"
    return 1
  )
}

stderr() {
  echo "$@" 1>&2
}

atoi() {
  #Returns the integer representation of an IP arg, passed in ascii dotted-decimal notation (x.x.x.x)
  IP=$1; IPNUM=0
  for (( i=0 ; i<4 ; ++i )); do
  ((IPNUM+=${IP%%.*}*$((256**$((3-${i}))))))
  IP=${IP#*.}
  done
  echo $IPNUM
} 

itoa() {
  #returns the dotted-decimal ascii form of an IP arg passed in integer format
  echo -n $(($(($(($((${1}/256))/256))/256))%256)).
  echo -n $(($(($((${1}/256))/256))%256)).
  echo -n $(($((${1}/256))%256)).
  echo $((${1}%256))
}

alloc_address() {
  node="$1"
  startip=$(atoi "$2")
  endip=$(atoi "$3")

  for (( i=$startip; i<=$endip; i=i+1 )); do
    ip=$(itoa $i)
    ipfile="addresses/$ip.node"

    if [[ ! -e "$ipfile" ]]; then
      # allocate new IP
      echo "$node" > $ipfile
      echo "$ip"
      return 0
    elif [[ "$(cat "$ipfile")" == "$node" ]]; then
      # return existing IP
      echo "$ip"
      return 0
    fi
  done

  echo "No free addresses" 1>&2
  return 1
}

load_config() {
  start_ip=$(get_value "$1" "StartIp")
  end_ip=$(get_value "$1" "EndIp")
}
